name: Update Daily Commit Table

on:
  schedule:
    - cron: '1 15 * * *'  # ë§¤ì¼ KST 00:01 ì‹¤í–‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-table:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README table
        run: |
          # ì˜¤ëŠ˜ ë‚ ì§œ (KST ê¸°ì¤€)
          KST_DATE=$(TZ=Asia/Seoul date +"%Y-%m-%d")
          TODAY=$(TZ=Asia/Seoul date +"%m-%d")

          # ì‹œê°„ ë²”ìœ„ (UTC ê¸°ì¤€): ì˜¤ëŠ˜ ìžì • ~ ì˜¤ëŠ˜ 23:59
          START_TIME=$(date -u -d "$KST_DATE 00:00:00" +"%Y-%m-%dT%H:%M:%SZ")
          END_TIME=$(date -u -d "$KST_DATE 23:59:59" +"%Y-%m-%dT%H:%M:%SZ")

          USERS=("ìœ ì§„" "ë¯¿ë””" "ì‚¬ëž€" "ìˆ­ë””" "ì¦ˆí›„" "ì• ìš©")
          GH_USERS=("breadbirds" "itsanisland" "icpc365" "bmlsj" "bluemango0312" "hanayoung")

          LINE="| $TODAY "
          for i in "${!USERS[@]}"; do
            user=${USERS[$i]}
            gh_id=${GH_USERS[$i]}

            count=$(curl -s "https://api.github.com/search/commits?q=author:$gh_id+committer-date:$START_TIME..$END_TIME" \
              -H "Accept: application/vnd.github.cloak-preview" | grep '"total_count": 0' || echo "âœ…")

            if [[ "$count" == *"0"* ]]; then
              LINE="$LINE| âŒ "
            else
              LINE="$LINE| âœ… "
            fi
          done
          LINE="$LINE|"

          echo "ðŸ“‹ ìž‘ì„±ëœ ì¤„: $LINE"

          # README.md ê°±ì‹ 
          awk -v date="$TODAY" -v newline="$LINE" '
          BEGIN{updated=0}
          {
            if ($0 ~ "\\| "date" \\|") {
              print newline
              updated=1
            } else {
              print $0
            }
          }
          END{
            if (updated==0) {
              print newline
            }
          }' README.md > tmp && mv tmp README.md

      - name: Commit updated README
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add README.md
          git commit -m "âœ… $TODAY ì»¤ë°‹ í˜„í™© ê°±ì‹ " || echo "No change"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
