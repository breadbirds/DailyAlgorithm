name: Update Daily Commit Table

on:
  schedule:
    - cron: '1 15 * * *'  # 매일 KST 00:01 실행
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-table:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Update README table
        run: |
          # 오늘 날짜 (KST 기준)
          KST_DATE=$(TZ=Asia/Seoul date +"%Y-%m-%d")
          TODAY=$(TZ=Asia/Seoul date +"%m-%d")

          # 시간 범위 (UTC 기준): 오늘 자정 ~ 오늘 23:59
          START_TIME=$(date -u -d "$KST_DATE 00:00:00" +"%Y-%m-%dT%H:%M:%SZ")
          END_TIME=$(date -u -d "$KST_DATE 23:59:59" +"%Y-%m-%dT%H:%M:%SZ")

          USERS=("유진" "사란" "믿디" "숭디" "애용" "즈후")
          GH_USERS=("breadbirds" "icpc365" "itsanisland" "bmlsj" "hanayoung" "bluemango0312")

          REPO_NAME="breadbirds/DailyAlgorithm"
          LINE="| $TODAY "

          for i in "${!USERS[@]}"; do
            user=${USERS[$i]}
            gh_id=${GH_USERS[$i]}

            QUERY="repo:$REPO_NAME+author:$gh_id+committer:$gh_id+committer-date:$START_TIME..$END_TIME"
            count=$(curl -s "https://api.github.com/search/commits?q=$QUERY" \
              -H "Accept: application/vnd.github.cloak-preview" | jq '.total_count')

            echo "$user ($gh_id): count = $count"

            if [[ "$count" =~ ^[0-9]+$ && "$count" -gt 0 ]]; then
              LINE="$LINE| ✅ "
            else
              LINE="$LINE| ❌ "
            fi
          done
          LINE="$LINE|"

          echo "📋 작성된 줄: $LINE"
          

          # README.md 갱신
          awk -v date="$TODAY" -v newline="$LINE" '
          BEGIN{updated=0}
          {
            if ($0 ~ "\\| "date" \\|") {
              print newline
              updated=1
            } else {
              print $0
            }
          }
          END{
            if (updated==0) {
              print newline
            }
          }' README.md > tmp && mv tmp README.md

      - name: Commit updated README
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add README.md
          git commit -m "✅ [$TODAY] 커밋 현황 갱신" || echo "No change"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
